<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Estimations</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">

    <style>
.card-img-top {
	width: 100%;
height: 25vh;
					object-fit: cover;
				}

        input:invalid {
    border: 1px solid red;
}

/* Style for valid inputs */
input:valid {
    border: 1px solid green;
}
</style>
  </head>

  <body>

    <div class="container">
      <div class="row justify-content-center">
        <div class="col p-2">
          <h1>Quotation Form</h1>
        </div>
      </div>
      <form id="form" class="row g-3 needs-validation bg-primary-subtle" novalidate>
        <div class="page1 row">
          <div class="col-md-4 p-2">

            <div class="input-group w-100">

              <div class="card w-100">
                <img src="UnfinishedHousing.jpg" class="card-img-top"
                  alt="Unfinished Housing">
                <div class="card-body">

                  <p class="card-text">Bare Housing</p>
                  <p class="card-text">22,000 php/sqm</p>
                  <input class="btn-check" type="radio" name="houseType"
                    id="houseType1"
                    checked data-price="22000">
                  <label class="btn btn-outline-success"
                    for="houseType1">Select</label>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4 p-2">
            <div class="input-group w-100">

              <div class="card w-100">
                <img src="standardhousing.jpg" class="card-img-top"
                  alt="Standard Housing">
                <div class="card-body">
                  <p class="card-text">Standard Housing</p>
                  <p class="card-text">35,000 php/sqm</p>
                  <input class="btn-check" type="radio" name="houseType"
                    id="houseType2" data-price="35000">
                  <label class="btn btn-outline-success"
                    for="houseType2">Select</label>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4 p-2">
            <div class="input-group w-100">

              <div class="card w-100">
                <img src="Highendhouse.jpg" class="card-img-top"
                  alt="High-End Housing">
                <div class="card-body">
                  <p class="card-text">High-End Housing</p>
                  <p class="card-text">45,000 php/sqm</p>
                  <input class="btn-check" type="radio" name="houseType"
                    id="houseType3" data-price="45000">
                  <label class="btn btn-outline-success"
                    for="houseType3">Select</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="page1 row">
          <div class="col-md-6">
            <label for="totalLotArea" class="form-label">Total Lot Area
              (sq.m.)</label>
            <input type="number" class="form-control propertyField"
              id="totalLotArea"
              name="totalLotArea" min="1" required>
            <div class="invalid-feedback">Please enter the total lot area.</div>
          </div>
          <div class="col-md-6">
            <label for="totalFloorArea" class="form-label">Total Floor Area
              (sq.m.)</label>
            <input type="number" class="form-control propertyField"
              id="totalFloorArea"
              name="totalFloorArea" min="1" required>
            <div class="invalid-feedback">Please enter the total floor
              area.</div>
          </div>
          <div class="col-md-6">
            <label for="numberOfFloors" class="form-label">Number of
              Floors</label>
            <input type="number" class="form-control propertyField"
              id="numberOfFloors"
              name="numberOfFloors" min="1" required>
            <div class="invalid-feedback">Please enter the number of
              floors.</div>
          </div>
          

          <div class="mb-3">
            <label for="pricePerSqm" class="form-label">Price per sqm
              (PHP):</label>
            <input type="number" class="form-control" id="pricePerSqm"
              value="22000"
              step="0.01" readonly data-required>
          </div>

          <div class="floors">

          </div>

          <div
            class="col-12">

            <button
              type="submit"
              class="btn btn-primary next-button" disabled>Next</button>

          </div>

        </div>

      </form>

      <div class="row summary" style="display: none;">
        <div id="summary-table"
          class="col-md-6 col-12 offset-md-3 bg-primary-subtle rounded p-3">
          <h1>Summary</h1>
          <div class="summary-text">
            <h3 id="totalFloorAreaSummary">Total Floor Area: </h3>
            <h3 id="totalAreaSqmSummary">Total Area: </h3>

            <table class="table table-hover">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Fee</th>
                  <th scope="col">Total Fee</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr id="floorCountSummaryRow">
                  <td>No. of Floor(s)</td>
                  <td id="floorCountSummary">1</td>
                  <td id="floorCountPrice">0</td>
                </tr>

              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container text-center">
        <span>&copy; All Right Reserved 2023</span>
      </div>
    </footer>

    <!--code end here-->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.min.js"
      integrity="sha512-WW8/jxkELe2CAiE4LvQfwm1rajOS8PHasCCx+knHG0gBHt8EXxS6T6tJRTGuDQVnluuAvMxWF4j8SNFDKceLFg=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/6.0.0/bootbox.min.js"
      integrity="sha512-oVbWSv2O4y1UzvExJMHaHcaib4wsBMS5tEP3/YkMP6GmkwRJAa79Jwsv+Y/w7w2Vb/98/Xhvck10LyJweB8Jsw=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script
      src="https://www.paypal.com/sdk/js?client-id=ATeqISSROuuS7bK3tVPiIcdhxAy3WZclv5tvPXCVinjR0hSgh95NYjC5Zrn5aMlRVgF3OkRxmZTx43Mw&components=buttons&currency=PHP"></script>
    <script type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const fetchData = async (url) => {
          try {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Network response was not ok.');
            }
            const data = await response.json();
            return data;
          } catch (error) {
            // Handle errors
            console.error('Error fetching data:', error);
            throw error;
          }
        };
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCSW7UMHtJDdRJga5oSEHgppvUsLRtagx0",
          authDomain: "jt25-fae27.firebaseapp.com",
          projectId: "jt25-fae27",
          storageBucket: "jt25-fae27.appspot.com",
          messagingSenderId: "590615766263",
          appId: "1:590615766263:web:95dc99f6487ba0693a1ff2",
          measurementId: "G-QB2Z7JDN2V"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        var totalPrice = 0;
        var downpayment = 0;
        const totalLotArea = $('#totalLotArea');
        const totalFloorArea = $('#totalFloorArea');
        const numberOfFloors = $('#numberOfFloors');
        const numberOfRooms = $('#numberOfRooms');
        const pricePerSqmInput = document.getElementById("pricePerSqm");

        const costs = {
          electricity: 0,
          bedroom: 0,
          kitchen: 0,
          barehouse: 0,
          highend: 0,
          publicBathroom: 0
        }

        $(document).ready(async ()=>{
          let dialog = bootbox.dialog({
                        message: '<p class="text-center mb-0"><i class="fas fa-spin fa-cog"></i> Fetching data...</p>',
                      closeButton: false
                      });

            try {
              for (let key in costs) {
                let data = await fetchData(`https://firestore.googleapis.com/v1/projects/jt25-fae27/databases/(default)/documents/summation/${key}`);
                console.log(`${key} data: `, data);
                costs[key] = parseInt(data.fields.total_price.integerValue);
                console.log(`${key} cost = ${costs[key]}`);
              }
              
              // Do something with the data here
            } catch (error) {
              // Handle errors here
              console.error('Error in getting data:', error);
              $('.next-button').remove();
              bootbox.alert('An error occured, Please reload the page or Contact the administrator');
            }
            
            dialog.modal('hide');
            $('.next-button').removeAttr('disabled');
        });

        

        $(`.back-button`).on('click', ()=>{
          $(`#paypal-button-container`).hide();
          $(`.page1`).show();
        });

        const form = document.querySelector('.needs-validation');
        form.addEventListener('submit', async (event) => {
          event.preventDefault(); // Prevent default form submission
          
          // Validate form fields
          if (form.checkValidity() === false) {
            event.stopPropagation();
            form.classList.add('was-validated'); // Show validation errors
            return;
          }

          let formError = isFormValid();
          if(formError.length > 0){
            bootbox.alert(formError);
            return;
          }

          if(totalPrice > 10000000){
            bootbox.alert("Sorry, but we can't handle projects above 10 million");
            $(`.next-button`).attr('disabled', true);
            return;
          }

          downpayment = (totalPrice / 100) * 25;

          $(`.page1`).hide();           

          if ($('#paypal-button-container').length == 0){
            $(`#form`).append(`<div id="paypal-button-container" style="max-width:1000px;"><h1 id="totalPriceSummary">Total Price: ${formatCurrency(totalPrice)}</h1><br><h3 id="downpaymentSummary">25% Downpayment: ${formatCurrency(downpayment)}</h3></div>`);
            paypal.Buttons({
                style: {
                  disableMaxWidth: true
                },
                createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        description: `This is your 25% downpayment of the total cost of ${formatCurrency(totalPrice)}`,
                        amount: {
                            value: downpayment,
                        }
                    }]
                });
            },
              async onApprove(orderData) {
                console.log(orderData);

                var dialog = bootbox.dialog({
                                message: '<p class="text-center mb-0"><i class="fas fa-spin fa-cog"></i> Processing your order...</p>',
                                closeButton: false
                                });

                $('#paypal-button-container').hide();

                $.ajax({
                  url: `https://jlt25-1b1f25d12d7f.herokuapp.com/paypal/capture/${orderData.orderID}`,
                  type: 'POST',
                  dataType: 'json',
                  contentType: 'application/json',
                  success: async function(response) {
                    console.log('Response:', response);

                    let user = auth.currentUser;
                    let email = response.payer.email_address;
                    if (user) {
                      email = user.email;
                    }
                    const propertyData = {
                      orderId: orderData.orderID,
                      email: email,
                      totalLotArea: parseInt(document.getElementById('totalLotArea').value),
                      totalFloorArea: parseInt(document.getElementById('totalFloorArea').value),
                      numberOfFloors: parseInt(document.getElementById('numberOfFloors').value),
                      numberOfBathrooms: parseInt(document.getElementById('numberOfBathrooms').value),
                      numberOfRooms: parseInt(document.getElementById('numberOfRooms').value),
                      totalPrice: totalPrice,
                      downpayment: downpayment,
                      timestamp: serverTimestamp()
                    };

                    try{
                      // Add a new document with a generated id.
                      const createdDocument = await addDoc(collection(db, "quotations"), propertyData);
                      console.log(createdDocument);


                      }
                      catch(error){
                        bootbox.alert(error);
                      }

                    dialog.modal('hide');
                    // Handle the response data here
                  },
                  error: function(xhr, status, error) {
                    console.error('Error:', error);
                    dialog.modal('hide');
                    bootbox.alert(error);
                    
                    // Handle errors here
                  }
                });


                
                // console.log("Document written with ID: ", createdDocument.id);
              },
              onCancel(data) {
                // Show a cancel page, or return to cart
              },
              onError(err) {
                // For example, redirect to a specific error page
                bootbox.alert(err);
              }
            }).render('#paypal-button-container');

            
          
          }
          else{
            $('#paypal-button-container').show();
          }
        });

        $('form').on('change', '.propertyField', ()=>{
          calculateQuotation();
          updateSummary();
        });

        $('#numberOfFloors').change(floorCountUpdated);
        $('#numberOfFloors').on('input', floorCountUpdated);

        $('input[name="houseType"]').click(function(){
          var price = $(this).data('price');
          $('#pricePerSqm').val(price);
          console.log(price);
          calculateQuotation();

          updateSummary();
        });

        function isFormValid(){
          if(parseInt(totalFloorArea.val()) > parseInt(totalLotArea.val())){
            return `Total Lot Area must be larger than floor area!`;
          }
          return '';
        }

        function formatCurrency(number, currencyCode = 'PHP') {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: currencyCode
          }).format(number);
        }

        function generateRandomPassword(length=8) {
          const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let password = '';
          
          for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * charset.length);
            password += charset[randomIndex];
          }
          
          return password;
        }

        function calculateQuotation() {
            const pricePerSqm = parseFloat(pricePerSqmInput.value);
            const floorCount = parseInt(numberOfFloors.value);
            const bedRoomCount = parseInt(numberOfRooms.value)

            if (isNaN(pricePerSqm)) {
              return;
            }
            const sqm = totalFloorArea.val();
            totalPrice = (sqm * pricePerSqm) * floorCount;

            let bedroomFees = costs.bedroom;

            bedroomFees *= bedRoomCount;

            totalPrice += bedroomFees;
            downpayment = (totalPrice / 100) * 25;
            
            if(totalPrice > 10000000){
              bootbox.alert("Sorry, but we can't handle projects above 10 million");
              $(`.next-button`).attr('disabled', true);
              return;
            }
        }

      function updateSummary(){
        console.log(`updating summary`);
        let summary = $('.summary-text');        
        $('#totalFloorAreaSummary').text(`Total Floor Area: ${totalFloorArea.val()}`);
        $('#totalLotAreaSummary').text(`Total Lot Area: ${totalLotArea.val()}`);

        let floorCount = parseInt(numberOfFloors.val());
        $(`#floorCountSummary`).text(`x${floorCount}`);
        $(`#totalPriceSummary`).text(`Total Price:${formatCurrency(totalPrice)}`);
        $(`#downpaymentSummary`).text(`25% Downpayment: ${formatCurrency(downpayment)}`);
      }

      function floorCountUpdated(){
        // Your function or action when the input value changes
        var floorCount = parseInt($(this).val());

        if(floorCount <= 0){
          return;
        }
        
        console.log(floorCount);
        $(".floors").empty();

        for(var i = 0; i < floorCount; i++){

          let floorTemplate = `
            <div class="row page1 floor-config">
                <div class="col-md-4 col-12 offset-md-4  bg-primary-subtle rounded p-3">
                    <h3>${getOrdinal(i + 1)} Floor</h3>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input restRoomToogle" type="checkbox" role="switch" id="floorRestroom${i}">
                            <label class="form-check-label" for="floorRestroom${i}">Does it have a restroom?</label>
                        </div>
                    </div>
                    <div class="mb-3">
                      <label
                        for="numberOfRooms"
                        class="form-label">Number of Bedrooms</label>

                      <input
                        type="number"
                        class="form-control propertyField bedrooms"
                        id="numberOfRooms"
                        name="numberOfRooms" min="1" required>
                      <div class="invalid-feedback">Please enter the number of
                        bedrooms.</div>
                    </div>
                </div>
            </div>`;

          $(".floors").append(floorTemplate);
        }
      }


        function getOrdinal(n) {
          const suffixes = ["st", "nd", "rd"];
          const suffix = n % 10 < 4 && Math.floor(n / 10) !== 1 ? suffixes[n % 10 - 1] : "th";
          return n + suffix;
        }
        
    </script>
    <script>
      
  $(function(){    
    $.get("navbar.html", function(data) {
      $("body").prepend(data); // Append content.html data into the #container div
    });

    
    
  });
</script>

  </body>
</html>
